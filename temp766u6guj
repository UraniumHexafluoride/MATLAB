classdef DownAndDirtyPlotApp < matlab.apps.AppBase
    % DownAndDirtyPlotApp A minimal, fast-track MAT-file plotting tool
    
    %% UI components
    properties (Access = public)
        UIFigure matlab.ui.Figure
        LeftPanel matlab.ui.container.Panel
        LoadButton matlab.ui.control.Button
        VariableListBox matlab.ui.control.ListBox
        PlotButton matlab.ui.control.Button
        StatusLabel matlab.ui.control.Label
        UIAxes matlab.ui.control.UIAxes

        %% --- START MODIFIED CODE BLOCK (Label Input Fields + New Controls) ---
        TitleFieldLabel matlab.ui.control.Label
        TitleField matlab.ui.control.EditField
        XLabelFieldLabel matlab.ui.control.Label
        XLabelField matlab.ui.control.EditField
        YLabelFieldLabel matlab.ui.control.Label
        YLabelField matlab.ui.control.EditField

        PlotTypeDropDownLabel matlab.ui.control.Label % NEW
        PlotTypeDropDown matlab.ui.control.DropDown    % NEW
        ExportButton matlab.ui.control.Button          % NEW
        %% --- END MODIFIED CODE BLOCK (Label Input Fields + New Controls) ---
    end
    
    %% Internal properties (Focus on Essentials)
    properties (Access = private)
        DataStruct % Holds the loaded MAT file data structure
        FileName   % Full path of the loaded file
        PROGRAM_NAME = 'DownAndDirty Plot Tool v1.1'; % Updated Version
        TopLevelVarName = ''; % Stores the name of the main struct/variable
    end
    
    
    %% Callbacks & Core Logic
    methods (Access = private)
        
        % --- File Loading and List Population (Unchanged) ---
        function LoadButtonPushed(app, event)
            [file, path] = uigetfile('*.mat','Select MAT file');
            if isequal(file,0)
                return;
            end
            app.FileName = fullfile(path,file);
            
            try
                S = load(app.FileName);
                topVars = fieldnames(S);
                app.DataStruct = S;
                app.VariableListBox.Value = {};
                cla(app.UIAxes);

                if numel(topVars) == 1 && isstruct(S.(topVars{1}))
                    % Case 1: Single top-level struct (LRTD common case)
                    app.TopLevelVarName = topVars{1};
                    app.VariableListBox.Items = fieldnames(S.(app.TopLevelVarName));
                    app.StatusLabel.Text = ['Loaded struct fields from: ' app.TopLevelVarName];
                else
                    % Case 2: Multiple variables or single array
                    app.TopLevelVarName = '';
                    app.VariableListBox.Items = topVars;
                    app.StatusLabel.Text = ['Loaded top-level variables from: ' file];
                end
                
            catch ME
                uialert(app.UIFigure, ['Failed to load file: ' ME.message],'Load Error');
                app.DataStruct = struct();
            end
        end
        
        %% --- START MODIFIED CODE BLOCK (PlotButtonPushed: Custom Labels & Plot Types) ---
        function PlotButtonPushed(app, event)
            if isempty(app.DataStruct) || isempty(app.VariableListBox.Value)
                app.StatusLabel.Text = 'Please load a file and select a variable/field.';
                return;
            end
            
            sel = app.VariableListBox.Value;
            cla(app.UIAxes);
            hold(app.UIAxes, 'on');
            
            fieldName = sel{1}; 
            fullPath = fieldName;
            
            try
                % Determine how to access the data
                if ~isempty(app.TopLevelVarName)
                    val = app.DataStruct.(app.TopLevelVarName).(fieldName);
                    fullPath = [app.TopLevelVarName, '.', fieldName];
                else
                    val = app.DataStruct.(fieldName);
                end
                
                if ~isnumeric(val)
                    app.StatusLabel.Text = ['Cannot plot non-numeric variable: ' fullPath];
                    text(app.UIAxes, 0.5, 0.5, 'Non-numeric Data','HorizontalAlignment','center');
                    app.addGraphMetadata(app.UIAxes, app.FileName, fullPath);
                    return;
                end
                
                val = double(val(:)); % Ensure it's a double column vector
                
                % --- Determine Labels from Input Fields ---
                xLabelText = app.XLabelField.Value;
                yLabelText = app.YLabelField.Value;
                titleText = app.TitleField.Value;
                plotType = app.PlotTypeDropDown.Value;
                
                if isempty(xLabelText), xLabelText = 'Index'; end
                
                if iscomplex(val)
                    % --- COMPLEX DATA PLOTTING (Line Plot only) ---
                    plot(app.UIAxes, real(val), 'DisplayName', 'Real Part', 'LineWidth', 1.5);
                    plot(app.UIAxes, imag(val), 'DisplayName', 'Imag Part', 'LineWidth', 1.5, 'LineStyle', '--');
                    
                    if isempty(yLabelText), yLabelText = 'Amplitude'; end
                    if isempty(titleText), titleText = ['Complex Data Plot (Line): ' fullPath]; end
                    
                else
                    % --- SIMPLE NUMERIC PLOTTING (Variable Plot Type) ---
                    switch plotType
                        case 'Line Plot (Default)'
                            plot(app.UIAxes, val, 'DisplayName', fullPath, 'LineWidth', 1.5);
                        case 'Scatter Plot'
                            scatter(app.UIAxes, 1:length(val), val, 'filled', 'DisplayName', fullPath);
                        case 'Bar Chart'
                            bar(app.UIAxes, val, 'DisplayName', fullPath);
                        otherwise % Fallback
                            plot(app.UIAxes, val, 'DisplayName', fullPath, 'LineWidth', 1.5);
                    end
                    
                    if isempty(yLabelText), yLabelText = 'Value'; end
                    if isempty(titleText), titleText = ['Data Plot (' plotType '): ' fullPath]; end
                end
                
                % Set custom or fallback labels
                title(app.UIAxes, titleText,'Interpreter','none');
                ylabel(app.UIAxes, yLabelText);
                xlabel(app.UIAxes, xLabelText);
                
                legend(app.UIAxes, 'show', 'Location', 'northeast');
                grid(app.UIAxes, 'on');
                
                app.StatusLabel.Text = ['Plotted field: ' fullPath ' as ' plotType];
                
            catch ME
                app.StatusLabel.Text = ['Plotting Error for ' fullPath ': ' ME.message];
                text(app.UIAxes, 0.5, 0.5, 'Plotting Error','HorizontalAlignment','center');
            end
            
            % --- MANDATORY METADATA OVERLAY ---
            app.addGraphMetadata(app.UIAxes, app.FileName, fullPath);
        end
        %% --- END MODIFIED CODE BLOCK (PlotButtonPushed: Custom Labels & Plot Types) ---

        % --- New Export to PNG Function ---
        function ExportButtonPushed(app, event)
            if isempty(app.DataStruct)
                uialert(app.UIFigure, 'No file loaded. Please load a MAT file first.','Export Error');
                return;
            end
            
            % Check if the axes are actually plotted (i.e., not empty)
            if isempty(app.UIAxes.Children)
                 uialert(app.UIFigure, 'The plot area is empty. Plot a variable before exporting.','Export Error');
                 return;
            end

            % Get filename and path from user
            [file, path] = uiputfile('*.png','Save Plot as PNG', 'ExportedPlot.png');
            if isequal(file,0)
                app.StatusLabel.Text = 'Export cancelled.';
                return;
            end
            
            fullFileName = fullfile(path, file);
            
            try
                % Use exportgraphics for high-quality export of axes content
                exportgraphics(app.UIAxes, fullFileName, 'Resolution', 300);
                app.StatusLabel.Text = ['Plot successfully exported to: ' fullFileName];
            catch ME
                uialert(app.UIFigure, ['Export failed: ' ME.message],'Export Error');
            end
        end

        
        % --- MANDATORY METADATA IMPLEMENTATION (Unchanged) ---
        function addGraphMetadata(app, hAx, filePath, dataPathStr)
            % Implements the required red "SECRET" tags, UTC time, and paths.
            
            currentTimeUTC = datetime('now', 'TimeZone', 'UTC');
            timeStr = datestr(currentTimeUTC, 'yyyy-mm-dd HH:MM:SS');
            
            % Top-Left SECRET Tag (Red, Bold)
            text(hAx, 0.02, 0.98, 'SECRET', ...
                'Units', 'normalized', ...
                'HorizontalAlignment', 'left', ...
                'VerticalAlignment', 'top', ...
                'FontWeight', 'bold', ...
                'Color', [0.8 0 0], ... 
                'FontSize', 11);
            
            % Bottom-Right SECRET Tag (Red, Bold)
            text(hAx, 0.98, 0.02, 'SECRET', ...
                'Units', 'normalized', ...
                'HorizontalAlignment', 'right', ...
                'VerticalAlignment', 'bottom', ...
                'FontWeight', 'bold', ...
                'Color', [0.8 0 0], ...
                'FontSize', 11);
            
            % Bottom-Left Metadata Block (Paths and Time)
            fullMetadataStr = { ...
                ['File Path: ' filePath], ... 
                ['Data Path: ' dataPathStr], ...      
                ['Program: ' app.PROGRAM_NAME], ...
                ['Time Plotted (UTC): ' timeStr] ... 
            };
            
            text(hAx, 0.02, 0.02, fullMetadataStr, ...
                'Units', 'normalized', ...
                'HorizontalAlignment', 'left', ...
                'VerticalAlignment', 'bottom', ...
                'FontSize', 8, ...
                'Interpreter', 'none'); 
        end
        
    end
    
    
    %% App Lifecycle & Component Creation (Minimal Boilerplate)
    methods (Access = public)
        
        % Constructor
        function app = DownAndDirtyPlotApp()
            app.createComponents();
            registerApp(app, app.UIFigure);
            app.startupFcn();
            if nargout == 0
                clear app
            end
        end

        % Startup function
        function startupFcn(app)
            app.StatusLabel.Text = 'Ready. Load a .mat file.';
        end
        
        % Delete function
        function delete(app)
            delete(app.UIFigure);
        end
        
        %% --- START MODIFIED CODE BLOCK (Component Creation: Added Input Fields & New Controls) ---
        function createComponents(app)
            app.UIFigure = uifigure('Visible', 'off');
            app.UIFigure.Position = [100 100 800 600];
            app.UIFigure.Name = 'Down-and-Dirty Plot Tool';

            % Left Panel for Controls
            app.LeftPanel = uipanel(app.UIFigure);
            app.LeftPanel.Title = 'Data';
            app.LeftPanel.Position = [5 5 200 590];

            app.LoadButton = uibutton(app.LeftPanel, 'push');
            app.LoadButton.Text = 'Load MAT File';
            app.LoadButton.Position = [10 550 180 30];

            % Title
            app.TitleFieldLabel = uilabel(app.LeftPanel);
            app.TitleFieldLabel.Text = 'Title:';
            app.TitleFieldLabel.Position = [10 525 40 20];
            app.TitleField = uieditfield(app.LeftPanel, 'text');
            app.TitleField.Position = [50 525 140 22];
            
            % X-Axis Label
            app.XLabelFieldLabel = uilabel(app.LeftPanel);
            app.XLabelFieldLabel.Text = 'X-Label:';
            app.XLabelFieldLabel.Position = [10 495 50 20];
            app.XLabelField = uieditfield(app.LeftPanel, 'text');
            app.XLabelField.Position = [60 495 130 22];
            
            % Y-Axis Label
            app.YLabelFieldLabel = uilabel(app.LeftPanel);
            app.YLabelFieldLabel.Text = 'Y-Label:';
            app.YLabelFieldLabel.Position = [10 465 50 20];
            app.YLabelField = uieditfield(app.LeftPanel, 'text');
            app.YLabelField.Position = [60 465 130 22];

            % --- NEW: Plot Type Dropdown ---
            app.PlotTypeDropDownLabel = uilabel(app.LeftPanel);
            app.PlotTypeDropDownLabel.Text = 'Plot Type:';
            app.PlotTypeDropDownLabel.Position = [10 435 70 20];
            
            app.PlotTypeDropDown = uidropdown(app.LeftPanel);
            app.PlotTypeDropDown.Items = {'Line Plot (Default)', 'Scatter Plot', 'Bar Chart'};
            app.PlotTypeDropDown.Value = 'Line Plot (Default)';
            app.PlotTypeDropDown.Position = [80 435 110 22];
            
            % Variable List Box (Adjusted Position)
            app.VariableListBox = uilistbox(app.LeftPanel);
            app.VariableListBox.Position = [10 100 180 325]; % Adjusted height and start point
            app.VariableListBox.Multiselect = 'off';

            % --- NEW: Export Button ---
            app.ExportButton = uibutton(app.LeftPanel, 'push');
            app.ExportButton.Text = 'Export to PNG';
            app.ExportButton.Position = [10 60 180 30];
            app.ExportButton.ButtonPushedFcn = createCallbackFcn(app, @ExportButtonPushed, true);
            
            % Plot Button (Moved up slightly to accommodate Export button)
            app.PlotButton = uibutton(app.LeftPanel, 'push');
            app.PlotButton.Text = 'PLOT SELECTED';
            app.PlotButton.Position = [10 10 180 30];

            % --- Connect Callbacks ---
            app.LoadButton.ButtonPushedFcn = createCallbackFcn(app, @LoadButtonPushed, true);
            app.PlotButton.ButtonPushedFcn = createCallbackFcn(app, @PlotButtonPushed, true);

            % Main Plotting Axes
            app.UIAxes = uiaxes(app.UIFigure);
            app.UIAxes.Position = [210 30 585 565];
            app.UIAxes.Title.String = 'Plotting Area';
            app.UIAxes.XGrid = 'on';
            app.UIAxes.YGrid = 'on';

            % Status Bar
            app.StatusLabel = uilabel(app.UIFigure);
            app.StatusLabel.Position = [210 5 380 20];
            app.StatusLabel.Text = 'Initializing...';
            
            app.UIFigure.Visible = 'on';
        end
        %% --- END MODIFIED CODE BLOCK (Component Creation: Added Input Fields & New Controls) ---
    end
    
end



% plot_mat_data.m
% Non-App MATLAB script to load, plot, label, and export data from a MAT file.
% This script runs sequentially and uses the Command Window for user input.

function plot_mat_data()
    PROGRAM_NAME = 'Non-App Plotting Script v1.1';
    
    disp('--- Starting Data Plotting Script ---');
    
    % 1. FILE SELECTION AND LOADING
    [file, path] = uigetfile('*.mat','Select MAT file to load');
    if isequal(file, 0)
        disp('File loading cancelled.');
        return;
    end
    
    filePath = fullfile(path, file);
    try
        S = load(filePath);
        disp(['Successfully loaded: ' filePath]);
    catch ME
        warning(['Failed to load file: ' ME.message]);
        return;
    end
    
    % 2. VARIABLE/FIELD SELECTION
    
    % Check for single top-level structure (LRTD common case)
    topVars = fieldnames(S);
    if numel(topVars) == 1 && isstruct(S.(topVars{1}))
        topLevelVarName = topVars{1};
        dataFields = fieldnames(S.(topLevelVarName));
        fprintf('Found main structure: %s\n', topLevelVarName);
    else
        topLevelVarName = '';
        dataFields = topVars;
    end
    
    fprintf('\nAvailable data fields/variables:\n');
    for i = 1:numel(dataFields)
        fprintf('[%d] %s\n', i, dataFields{i});
    end
    
    % Prompt user for selection
    idx = input('Enter the number corresponding to the variable/field to plot: ');
    if isempty(idx) || idx < 1 || idx > numel(dataFields)
        warning('Invalid selection. Exiting.');
        return;
    end
    
    fieldName = dataFields{idx};
    
    % Access the data value and define the full data path string
    if ~isempty(topLevelVarName)
        val = S.(topLevelVarName).(fieldName);
        fullPath = [topLevelVarName, '.', fieldName];
    else
        val = S.(fieldName);
        fullPath = fieldName;
    end
    
    if ~isnumeric(val)
        warning(['Cannot plot non-numeric variable: ' fullPath]);
        return;
    end
    
    val = double(val(:)); % Ensure it's a double column vector
    
    % 3. INPUT GATHERING (Labels and Plot Type)
    
    % Prompt for plot customization
    disp('--- Plot Customization ---');
    titleText = input('Enter Plot Title (Leave blank for default): ', 's');
    xLabelText = input('Enter X-Axis Label (Leave blank for "Index"): ', 's');
    yLabelText = input('Enter Y-Axis Label (Leave blank for "Value/Amplitude"): ', 's');

    if isempty(xLabelText), xLabelText = 'Index'; end

    if ~iscomplex(val)
        % Only prompt for plot type if data is real
        plotTypes = {'Line Plot', 'Scatter Plot', 'Bar Chart'};
        fprintf('\nAvailable Plot Types:\n');
        for i = 1:numel(plotTypes)
            fprintf('[%d] %s\n', i, plotTypes{i});
        end
        plotTypeIdx = input('Enter the number for Plot Type (Default is [1]): ');
        if isempty(plotTypeIdx) || plotTypeIdx < 1 || plotTypeIdx > numel(plotTypes)
            plotTypeIdx = 1; % Default to Line Plot
        end
        plotType = plotTypes{plotTypeIdx};
    else
        plotType = 'Line Plot (Complex)'; % Complex data always uses line plot
    end

    % 4. PLOTTING THE DATA
    hFig = figure('Name', ['Data Plot: ' fullPath], 'NumberTitle', 'off');
    hAx = axes('Parent', hFig);
    hold(hAx, 'on');
    grid(hAx, 'on');

    if iscomplex(val)
        % Complex Data Plotting
        plot(hAx, real(val), 'DisplayName', 'Real Part', 'LineWidth', 1.5);
        plot(hAx, imag(val), 'DisplayName', 'Imag Part', 'LineWidth', 1.5, 'LineStyle', '--');
        if isempty(yLabelText), yLabelText = 'Amplitude'; end
        if isempty(titleText), titleText = ['Complex Data Plot (Line): ' fullPath]; end
    else
        % Simple Numeric Plotting
        switch plotType
            case 'Line Plot'
                plot(hAx, val, 'DisplayName', fullPath, 'LineWidth', 1.5);
            case 'Scatter Plot'
                scatter(hAx, 1:length(val), val, 'filled', 'DisplayName', fullPath);
            case 'Bar Chart'
                bar(hAx, val, 'DisplayName', fullPath);
        end
        if isempty(yLabelText), yLabelText = 'Value'; end
        if isempty(titleText), titleText = ['Data Plot (' plotType '): ' fullPath]; end
    end

    % Apply Labels
    title(hAx, titleText, 'Interpreter', 'none');
    ylabel(hAx, yLabelText);
    xlabel(hAx, xLabelText);
    legend(hAx, 'show', 'Location', 'northeast');

    % 5. ADD MANDATORY METADATA
    add_metadata(hAx, filePath, fullPath, PROGRAM_NAME);

    disp('Plot generated in a new figure window.');
    
    % 6. EXPORTING TO PNG
    disp('--- Exporting Plot ---');
    [exportFile, exportPath] = uiputfile('*.png','Save Plot as PNG', 'ExportedPlot.png');
    if isequal(exportFile, 0)
        disp('Export cancelled.');
    else
        fullExportName = fullfile(exportPath, exportFile);
        try
            % Use exportgraphics for high-quality export
            exportgraphics(hAx, fullExportName, 'Resolution', 300);
            disp(['Plot successfully exported to: ' fullExportName]);
        catch ME
            warning(['Export failed: ' ME.message]);
        end
    end
    
end

% --- SUB-FUNCTION FOR MANDATORY METADATA ---
function add_metadata(hAx, filePath, dataPathStr, programName)
    % Implements the required red "SECRET" tags, UTC time, and paths.
    
    currentTimeUTC = datetime('now', 'TimeZone', 'UTC');
    timeStr = datestr(currentTimeUTC, 'yyyy-mm-dd HH:MM:SS');
    
    % Top-Left SECRET Tag (Red, Bold)
    text(hAx, 0.02, 0.98, 'SECRET', ...
        'Units', 'normalized', ...
        'HorizontalAlignment', 'left', ...
        'VerticalAlignment', 'top', ...
        'FontWeight', 'bold', ...
        'Color', [0.8 0 0], ... 
        'FontSize', 11);
    
    % Bottom-Right SECRET Tag (Red, Bold)
    text(hAx, 0.98, 0.02, 'SECRET', ...
        'Units', 'normalized', ...
        'HorizontalAlignment', 'right', ...
        'VerticalAlignment', 'bottom', ...
        'FontWeight', 'bold', ...
        'Color', [0.8 0 0], ...
        'FontSize', 11);
    
    % Bottom-Left Metadata Block (Paths and Time)
    fullMetadataStr = { ...
        ['File Path: ' filePath], ... 
        ['Data Path: ' dataPathStr], ...      
        ['Program: ' programName], ...
        ['Time Plotted (UTC): ' timeStr] ... 
    };
    
    text(hAx, 0.02, 0.02, fullMetadataStr, ...
        'Units', 'normalized', ...
        'HorizontalAlignment', 'left', ...
        'VerticalAlignment', 'bottom', ...
        'FontSize', 8, ...
        'Interpreter', 'none'); 
end
